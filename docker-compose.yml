name: robot_ws

x-common-env: &common_env
  ROS_DISTRO: foxy
  RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
  ROS_DOMAIN_ID: "7"
  ROS_LOCALHOST_ONLY: "0"
  CYCLONEDDS_URI: file:///etc/cyclonedds.xml

services:
  # =========================
  # Dev local (Mac/PC Linux)
  # =========================
  rover:
    # ⚠️ Profil supprimé pour être le service par défaut (fix VS Code)
    # profiles: [dev]  <-- Ligne retirée
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      target: image-generic
      args:
        ROS_DISTRO: foxy
    image: rover:foxy-generic
    network_mode: host
    privileged: true
    working_dir: /workspaces/robot_ws
    environment:
      <<: *common_env
      # Force le rendu logiciel pour Mac M1/M2/M3 (évite le crash GPU)
      LIBGL_ALWAYS_SOFTWARE: "1"
    # Bind de ton dossier local pour dev
    volumes:
      - type: bind
        source: .
        target: /workspaces/robot_ws
        bind:
          create_host_path: true
    # Commande de démarrage (VS Code va la surcharger, mais utile pour make dev-up)
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
    restart: unless-stopped

  # =========================
  # Exécution Jetson
  # =========================
  rover-jetson:
    profiles: [jetson]
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      target: image-jetson
      args:
        ROS_DISTRO: foxy
    image: rover:foxy-jetson
    network_mode: host
    privileged: true
    runtime: nvidia        # requis pour GPU Jetson
    working_dir: /workspaces/robot_ws
    environment:
      REPO_URL: "git@github.com:Hylosphere/robot_ws.git"
      REPO_BRANCH: ${REPO_BRANCH:-main}
      WS_DIR: "/workspaces/robot_ws"
      BUILD_ON_START: "0"
    volumes:
      - type: volume
        source: robot_ws
        target: /workspaces/robot_ws
      # ⬇️ Monte la clé SSH hôte -> conteneur (pour git pull)
      - type: bind
        source: /home/jetson/.ssh
        target: /root/.ssh
        read_only: true
    # Accès au matériel (USB/série, etc.)
    devices:
      - source: /dev
        target: /dev
        permissions: rwm
    # Démarrage robuste: seeder + build + lancement
    entrypoint: ["/entrypoint.sh"]
    command: ["bash","-lc","sleep infinity"]
    restart: unless-stopped

volumes:
  robot_ws:
    name: robot_ws_robot_ws