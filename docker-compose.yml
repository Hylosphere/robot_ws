version: '3.8'
name: robot_ws

x-common-env: &common_env
  ROS_DISTRO: foxy
  RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
  ROS_DOMAIN_ID: "7"
  ROS_LOCALHOST_ONLY: "0"
  CYCLONEDDS_URI: file:///etc/cyclonedds.xml

services:
  # =========================
  # Dev local (Mac/PC Linux)
  # =========================
  rover:
    # ⚠️ Profil supprimé pour être le service par défaut (fix VS Code)
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      target: image-generic
      args:
        ROS_DISTRO: foxy
    image: rover:foxy-generic
    
    # --- MODIFICATION POUR MAC (Début) ---
    # On remplace network_mode: host par l'ouverture explicite des ports
    ports:
      - "8080:8080"  # VNC Web
      - "5900:5900"  # VNC Viewer (Rapide)
      - "9090:9090"  # Foxglove
    # -------------------------------------

    privileged: true
    
    # Augmente la RAM vidéo partagée pour éviter le crash de RViz
    shm_size: '2gb'
    
    working_dir: /workspaces/robot_ws
    environment:
      <<: *common_env
      DISPLAY: ":0"
      # Force le rendu logiciel pour Mac M1/M2/M3
      LIBGL_ALWAYS_SOFTWARE: "1"
      # Empêche l'écran noir/plantage dans RViz sur Mac
      QT_X11_NO_MITSHM: "1"
      # Corrige les erreurs de logs Qt
      XDG_RUNTIME_DIR: "/tmp/runtime-root"
      
    # Bind de ton dossier local pour dev
    volumes:
      - type: bind
        source: .
        target: /workspaces/robot_ws
        bind:
          create_host_path: true
      # Nécessaire pour l'affichage graphique
      - /tmp/.X11-unix:/tmp/.X11-unix
      
    # Commande de démarrage
    command: ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
    restart: unless-stopped

  # =========================
  # Exécution Jetson (INCHANGÉ)
  # =========================
  rover-jetson:
    profiles: [jetson]
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
      target: image-jetson
      args:
        ROS_DISTRO: foxy
    image: rover:foxy-jetson
    network_mode: host
    privileged: true
    runtime: nvidia        # requis pour GPU Jetson
    working_dir: /workspaces/robot_ws
    environment:
      REPO_URL: "git@github.com:Hylosphere/robot_ws.git"
      REPO_BRANCH: ${REPO_BRANCH:-main}
      WS_DIR: "/workspaces/robot_ws"
      BUILD_ON_START: "0"
    volumes:
      - type: volume
        source: robot_ws
        target: /workspaces/robot_ws
      # ⬇️ Monte la clé SSH hôte -> conteneur (pour git pull)
      - type: bind
        source: /home/jetson/.ssh
        target: /root/.ssh
        read_only: true
    # Accès au matériel (USB/série, etc.)
    devices:
      - source: /dev
        target: /dev
        permissions: rwm
    # Démarrage robuste: seeder + build + lancement
    entrypoint: ["/entrypoint.sh"]
    command: ["bash","-lc","sleep infinity"]
    restart: unless-stopped

volumes:
  robot_ws:
    name: robot_ws_robot_ws